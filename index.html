<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rotatable Radial Angular Blur</title>
<style>
  body {margin:20px; font-family:system-ui;}
  canvas {border:1px solid #ccc;}
  label {margin-right:10px;}
</style>
</head>
<body>

<canvas id="c" width="700" height="700"></canvas>
<div>
  <input type="range" id="rotation" min="0" max="180" value="0" step="5" style="width:500px;">  <label>Rotation: <span id="rotVal">0</span>Â°</label>

</div>
<div>
  <input type="range" id="maxBlur" min="0" max="8" value="4" step="0.5" style="width:500px;">  <label>Max Blur: <span id="blurVal">4</span>px</label>

</div>


<script>
const RAW = "https://raw.githubusercontent.com/kiaraoptometrypx/RX_exam/main/fan_chart.png";
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2;

const img = new Image();
img.crossOrigin = "anonymous";
img.src = RAW;

let levels = 4;
let maxBlur = 2;
let gamma = 0.75; // smoother, more even blur
let rotationDeg = 0;
let layers = [];

img.onload = async () => {
  generateLayers();
  drawBlur();
};

// generate blur layers
function generateLayers() {
  layers = [];
  for(let i=0;i<levels;i++){
    const off = document.createElement("canvas");
    off.width = w; off.height = h;
    const octx = off.getContext("2d");
    const blurPx = (i/(levels-1)) * maxBlur;
    octx.filter = `blur(${blurPx}px)`;
    octx.drawImage(img, 0, 0, w, h);
    layers.push(octx.getImageData(0,0,w,h));
  }
}

// compute angular factor for each pixel
function angularFactor(x,y){
  const dx = x - cx;
  const dy = y - cy;
  let theta = Math.atan2(dy, dx); // radians
  theta -= rotationDeg * Math.PI/180; // apply rotation
  let v = (Math.cos(2*theta)+1)/2;
  return Math.pow(v, gamma);
}

// blend layers per pixel
function drawBlur(){
  const result = ctx.createImageData(w,h);
  const out = result.data;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx = (y*w+x)*4;
      const f = angularFactor(x,y);
      const floatIndex = f*(levels-1);
      const i0 = Math.floor(floatIndex);
      const i1 = Math.min(levels-1,i0+1);
      const t = floatIndex-i0;

      const d0 = layers[i0].data, d1 = layers[i1].data;
      out[idx]   = Math.round(d0[idx]*(1-t)+d1[idx]*t);
      out[idx+1] = Math.round(d0[idx+1]*(1-t)+d1[idx+1]*t);
      out[idx+2] = Math.round(d0[idx+2]*(1-t)+d1[idx+2]*t);
      out[idx+3] = d0[idx+3];
    }
  }

  ctx.putImageData(result,0,0);
}

// slider events
document.getElementById("rotation").addEventListener("input", e=>{
  rotationDeg = +e.target.value;
  document.getElementById("rotVal").textContent = rotationDeg;
  drawBlur();
});

document.getElementById("maxBlur").addEventListener("input", e=>{
  maxBlur = +e.target.value;
  document.getElementById("blurVal").textContent = maxBlur;
  generateLayers();
  drawBlur();
});
</script>

</body>
</html>
