<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Rotatable Angular Blur</title>
<style>
body {margin:20px;font-family:system-ui;}
canvas {border:1px solid #ccc; display:block; margin-bottom:20px;}
label {margin-left:10px;}
input[type=range]{-webkit-appearance:none;width:500px;height:8px;background:#ddd;border-radius:4px;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;background:#333;border-radius:50%;cursor:pointer;}
</style>
</head>
<body>

<canvas id="c" width="500" height="500"></canvas>

<div>
<input type="range" id="rotation" min="0" max="360" value="0" step="0.5">
<label>Rotation: <span id="rotVal">0</span>Â°</label>
</div>
<div>
<input type="range" id="maxBlur" min="0" max="12" value="4" step="0.1">
<label>Max Blur: <span id="blurVal">4</span>px</label>
</div>

<script>
const RAW="https://raw.githubusercontent.com/kiaraoptometrypx/RX_exam/main/fan_chart.png";
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
const w=canvas.width,h=canvas.height,cx=w/2,cy=h/2;

const img=new Image();
img.crossOrigin="anonymous";
img.src=RAW;

let levels=12;        // more levels = smoother blur
let maxBlur=4;
let gamma=0.75;
let rotationDeg=0;
let layers=[];

img.onload=()=>{generateLayers(); drawBlur();};

// generate multiple blurred layers
function generateLayers(){
  layers=[];
  for(let i=0;i<levels;i++){
    const off=document.createElement("canvas");
    off.width=w; off.height=h;
    const octx=off.getContext("2d");
    const blurPx=(i/(levels-1))*maxBlur; // linear steps
    octx.filter=`blur(${blurPx}px)`;
    octx.drawImage(img,0,0,w,h);
    layers.push(octx.getImageData(0,0,w,h));
  }
}

// angular factor 0..1 per pixel
function angularFactor(x,y){
  const dx=x-cx, dy=y-cy;
  let theta=Math.atan2(dy,dx)-rotationDeg*Math.PI/180;
  let v=(Math.cos(2*theta)+1)/2;
  return Math.pow(v,gamma);
}

// blend layers per pixel
function drawBlur(){
  const result=ctx.createImageData(w,h);
  const out=result.data;

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      const idx=(y*w+x)*4;
      const f=angularFactor(x,y);
      const floatIndex=f*(levels-1);
      const i0=Math.floor(floatIndex), i1=Math.min(levels-1,i0+1);
      const t=floatIndex-i0;

      const d0=layers[i0].data, d1=layers[i1].data;
      out[idx]   = Math.round(d0[idx]*(1-t)+d1[idx]*t);
      out[idx+1] = Math.round(d0[idx+1]*(1-t)+d1[idx+1]*t);
      out[idx+2] = Math.round(d0[idx+2]*(1-t)+d1[idx+2]*t);
      out[idx+3] = d0[idx+3];
    }
  }

  ctx.putImageData(result,0,0);
}

// slider handling
function setupSlider(id, callback){
  const s=document.getElementById(id);
  s.addEventListener("input",callback);
  s.addEventListener("change",callback);
}

setupSlider("rotation", e=>{
  rotationDeg=+e.target.value;
  document.getElementById("rotVal").textContent=rotationDeg;
  drawBlur();
});

setupSlider("maxBlur", e=>{
  maxBlur=+e.target.value;
  document.getElementById("blurVal").textContent=maxBlur;
  generateLayers();
  drawBlur();
});
</script>
</body>
</html>
